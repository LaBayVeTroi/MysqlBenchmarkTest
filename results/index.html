<html>
<head>
<!--
http://htmlpreview.github.io/?https://github.com/rusher/mariadb-java-driver-benchmark/blob/master/results/index.html
-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="stylesheet" href="./highlight/styles/github.css">
    <script src="./highlight/highlight.pack.js"></script>
    <script>

        google.charts.load('current', {'packages': ['corechart', 'bar']});
        function defaultMariaData() {

            var defaultData = new google.visualization.DataTable();
            defaultData.addColumn('string', 'Select one row');
            defaultData.addColumn('number', 'MariaDB-1.5.0');
            defaultData.addColumn({role: 'annotation', type: 'string'});
            defaultData.addColumn({id: 'min', type: 'number', role: 'interval'});
            defaultData.addColumn({id: 'max', type: 'number', role: 'interval'});
            return defaultData;

        };

        var defaultMariaDBOptions = {
            chartArea: {left: 280, top: 50, width: '50%', height: '55%'},
            hAxis: {
                title: 'microseconds',
                minValue: 0
            },
            series: {
                0: {color: '#3366CC'},
            },
            bars: 'horizontal',
            intervals: {
                barWidth: 0.7,
                shortBarWidth: 5,
                lineWidth: 2,
                style: 'boxes',
            },
            interval: {
                max: {
                    fillOpacity: 0.7,
                    color: '#444'
                },
                min: {
                    fillOpacity: 0.7,
                    color: '#444'
                }
            }
        };

        var defaultOptions = {
            chartArea: {width: '50%'},
            title: 'Time for select 1 row',
            height: 300,
            hAxis: {
                title: 'microseconds',
                minValue: 0
            },
            series: {
                0: {color: '#DB4437'},
                1: {color: '#4285F4'}
            },
            lineWidth: 0,
            //series: [{'color': '#D3362D'}],
            intervals: {
                barWidth: 0.7,
                shortBarWidth: 5,
                lineWidth: 2,
                style: 'boxes',
            },
            interval: {
                max: {
                    fillOpacity: 0.7,
                    color: '#444'
                },
                min: {
                    fillOpacity: 0.7,
                    color: '#444'
                }
            }
        };

        function defaultData() {

            var defaultData = new google.visualization.DataTable();
            defaultData.addColumn('string', 'x');
            defaultData.addColumn('number', 'MySQL-5.1.39');
            defaultData.addColumn({role: 'annotation', type: 'string'});
            defaultData.addColumn({id: 'min', type: 'number', role: 'interval'});
            defaultData.addColumn({id: 'max', type: 'number', role: 'interval'});
            defaultData.addColumn('number', 'MariaDB-1.5.0');
            defaultData.addColumn({role: 'annotation', type: 'string'});
            defaultData.addColumn({id: 'min', type: 'number', role: 'interval'});
            defaultData.addColumn({id: 'max', type: 'number', role: 'interval'});
            defaultData.addColumn('number', 'Drizzle-1.2');
            defaultData.addColumn({role: 'annotation', type: 'string'});
            defaultData.addColumn({id: 'min', type: 'number', role: 'interval'});
            defaultData.addColumn({id: 'max', type: 'number', role: 'interval'});
            return defaultData;
        }
        ;

        function defaultDataWithoutDrizzle() {

            var defaultData = new google.visualization.DataTable();
            defaultData.addColumn('string', 'x');
            defaultData.addColumn('number', 'MySQL-5.1.39');
            defaultData.addColumn({role: 'annotation', type: 'string'});
            defaultData.addColumn({id: 'min', type: 'number', role: 'interval'});
            defaultData.addColumn({id: 'max', type: 'number', role: 'interval'});
            defaultData.addColumn('number', 'MariaDB-1.5.0');
            defaultData.addColumn({role: 'annotation', type: 'string'});
            defaultData.addColumn({id: 'min', type: 'number', role: 'interval'});
            defaultData.addColumn({id: 'max', type: 'number', role: 'interval'});
            return defaultData;
        }
        ;

        function defaultDataMaria15() {
            var defaultData = new google.visualization.DataTable();
            defaultData.addColumn('string', 'x');
            defaultData.addColumn('number', 'MySQL-5.1.39');
            defaultData.addColumn({role: 'annotation', type: 'string'});
            defaultData.addColumn({id: 'min', type: 'number', role: 'interval'});
            defaultData.addColumn({id: 'max', type: 'number', role: 'interval'});
            defaultData.addColumn('number', 'MariaDB-1.5.0-SNAPSHOT');
            defaultData.addColumn({role: 'annotation', type: 'string'});
            defaultData.addColumn({id: 'min', type: 'number', role: 'interval'});
            defaultData.addColumn({id: 'max', type: 'number', role: 'interval'});
            return defaultData;
        }
        ;


        function getBoxPlotValues(array, showpercent) {

            var base = array[0][1];
            for (var i = 0; i < array.length; i++) {
                var length = array[i].length
                var reconstructArray = [array[i][0]];
                for (var j = 1; j < length; j = j + 2) {
                    reconstructArray.push(array[i][j]);
                    if (array[i][j] == 0 || !showpercent) {
                        reconstructArray.push('');
                    } else {
                        reconstructArray.push((Math.round(1000 * (array[i][j]) / base) / 10) + '% ');
                    }

                    reconstructArray.push(array[i][j] - array[i][j + 1]);
                    reconstructArray.push(array[i][j] + array[i][j + 1]);

                }

                array[i] = reconstructArray;
            }
            return array;
        }
        ;

        function getOneBoxPlotValues(array, showpercent) {
            var base = array[0][1];
            for (var i = 0; i < array.length; i++) {
                var length = array[i].length
                var reconstructArray = [array[i][0]];
                reconstructArray.push(array[i][1]);
                reconstructArray.push(showpercent ? (Math.round(1000 * (array[i][1]) / base) / 10) + '% ' : '');
                reconstructArray.push(array[i][1] - array[i][2]);
                reconstructArray.push(array[i][1] + array[i][2]);
                array[i] = reconstructArray;
            }
            return array;
        }
        ;
    </script>

    <style>
        pre {
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            border-radius: 3px;
            background: #f7f7f7;
            margin: 8px -7px;
            padding: 8px 7px;
        }
        code {
            padding: 0 0.2em;
            padding-top: 0.2em;
            padding-bottom: 0.2em;
            margin: 0.2em 0;
            font-size: 85%;
            background-color: rgba(0,0,0,0.04);
            border-radius: 3px;
            font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;

        }
        .container {
            width: 980px;
            margin-right: auto;
            margin-left: auto;
        }

        body {
            font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 16px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        h1, h2, h3, h4 {
            padding-bottom: 0.3em;
            line-height: 1.225;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>MariaDB java connector performance </h1>

    <p>We always talk about performance, but the thing is always "Measure, don't guess!".</p>
    <p>A lot of performance improvement has been done lately on the MariaDB java connector. So, what the current driver
        perf?</p>
    <p>Here is benchmark result of 3 jdbc drivers permitting access to a MySQL/MariaDB database: <a
            href="https://github.com/krummas/DrizzleJDBC" target="_blank">DrizzleJDBC</a>, <a
            href="https://github.com/mysql/mysql-connector-j" target="_blank">MySQL connector/J</a> and <a
            href="https://github.com/MariaDB/mariadb-connector-j" target="_blank">MariaDB java connector</a>.</p>

    Driver's versions are the latest GA available version at the time of writing this blog:
    <ul>
        <li>Mariadb 1.5.0</li>
        <li>Mysql5.1.39</li>
        <li>Drizzle 1.2</li>
    </ul>

    <br/>
    <h1>The benchmark</h1>
    <p>
        <a href="http://openjdk.java.net/projects/code-tools/jmh/">JMH</a> is an oracle micro-benchmarking framework tool developed by oracle, delivered as openJDK tools.
        Its distinctive advantage over other frameworks is that it is developed by the same guys in Oracle who implement JIT (Just In Time compilation).
        JMH is in sync with the latest Oracle JRE changes, which make its results very reliable, and permit to avoid most of micro-benchmark pitfalls.
    </p>

    <p> Benchmark source: <a href="https://github.com/rusher/mariadb-java-driver-benchmark">https://github.com/rusher/mariadb-java-driver-benchmark</a>.</p>

    Tests are pretty straightforward.<br/>
    Example :
	<pre><code class="java">
        public class BenchmarkSelect1RowPrepareText extends BenchmarkSelect1RowPrepareAbstract {

            @Benchmark
            public String mysql(MyState state) throws Throwable {
                return select1RowPrepare(state.mysqlConnectionText, state);
            }

            @Benchmark
            public String mariadb(MyState state) throws Throwable {
                return select1RowPrepare(state.mariadbConnectionText, state);
            }

            @Benchmark
            public String drizzle(MyState state) throws Throwable {
                return select1RowPrepare(state.drizzleConnectionText, state);
            }

        }

        public abstract class BenchmarkSelect1RowPrepareAbstract extends BenchmarkInit {
            private String request = "SELECT ?";

            public String select1RowPrepare(Connection connection, MyState state) throws SQLException {
                try (PreparedStatement preparedStatement = connection.prepareStatement(request)) {
                    preparedStatement.setString(1, state.insertData[state.counter++]);
                    try (ResultSet rs = preparedStatement.executeQuery()) {
                        rs.next();
                        return rs.getString(1);
                    }
                }
            }
        }
    </code></pre>

    <p>Tests using INSERT's queries are send to a <a href="https://mariadb.com/kb/en/mariadb/blackhole/">BLACKHOLE</a> engine (data are not stored).
        This permit to have more stable results.<br>
        (99.9% of queries execution time have 1-3% time difference, without using the blackhole engine, these execution times would vary up to 10%).
    </p>

    <br/>
    <h1>Results</h1>
    Execution (client and server ) is done on a single server droplet on digitalocean.com using this parameters:
    <ul>
        <li>Java(TM) SE Runtime Environment (build 1.8.0_101-b13) 64bits (actual last version in time of this benchmark)</li>
        <li>Ubuntu 16.04 64bits</li>
        <li>1GB memory</li>
        <li>1 CPU</li>
        <li>database 10.1.16-MariaDB MariaDB Server and 5.7.13 MySQL Community Server (GPL) with default configuration files + the folowing configuration :
            <ul>
                <li>max_allowed_packet      = 40M //exchange packet can be up to 40mb</li>
                <li>character-set-server    = utf8 //to use UTF-8 as default </li>
                <li>collation-server        = utf8_unicode_ci //to use UTF-8 as default </li>
            </ul>
        </li>
    </ul>

    <p>Results sample explanations:</p>

<pre class="java">
Benchmark                                           Mode  Cnt    Score     Error  Units
BenchmarkSelect1RowPrepareText.drizzle              avgt  150    81.795 &#177;  2.952  us/op
BenchmarkSelect1RowPrepareText.mariadb              avgt  150    51.106 &#177;  2.729  us/op
BenchmarkSelect1RowPrepareText.mysql                avgt  150    77.286 &#177;  2.437  us/op
</pre>

    <div id="box_select1Text"></div>
    <script>
        google.charts.setOnLoadCallback(function () {
            var data = defaultData();
            var array = [
                ['Using text protocol', 77.286, 2.437, 51.106,  2.729, 81.795,  2.952]
            ];
            data.addRows(getBoxPlotValues(array, true));

            var chart = new google.visualization.BarChart(document.getElementById('box_select1Text'));
            var select1RowsOption = defaultOptions;
            select1RowsOption.title = "Time for a query \"SELECT ?\"";
            select1RowsOption.height = 220;
            chart.draw(data, select1RowsOption);
        });
    </script>

    <p>
        This mean that query <code>SELECT ?</code> will take an average time of 51.106
        microseconds using mariadb driver with a variation of &#177; 2.729 microseconds for 99.9% of queries.
        (smaller execution time the better).
    </p>
    <p>
        Same execution using drizzle driver will take 81.795 microseconds, and 77.286 microseconds using mysql connector.
    </p>


    raw data results :
    <ol>
        <li><a href="./result_mariadb-10.1_server.txt">with a MariaDB 10.1.16 database</a></li>
        <li><a href="./result_mariadb-10.2_server.txt">with a MariaDB 10.2.2 database</a></li>
        <li><a href="./result_mysql-5.7_server.txt">with a MySQL Community Server 5.7.13 database (build 5.7.13-0ubuntu0.16.04.2)</a></li>
    </ol>

    <br/>

    <h2>To use or not to use server prepare</h2>
    This correspond to the option <a href="https://github.com/MariaDB/mariadb-connector-j/blob/master/documentation/Use-MariaDB-Connector-j-driver.md#useServerPrepStmts">useServerPrepStmts</a>.
    Definition : PreparedStatement queries will be prepared on the server side before executing, permitting faster execution next time. \\if allowMultiQueries or rewriteBatchedStatements is set to true, this option will be set to false.
    If not, Prepared statements (parameter substitution) is handled by the driver, on the client side.

    <p>When using MySQL/MariaDB server prepared statement, there will be 3 exchanges with server :
        <ol>
            <li>PREPARE - Prepares statement for execution.</li>
            <li>EXECUTE - Executes a prepared statement preparing by a PREPARE statement.</li>
            <li>DEALLOCATE PREPARE - Releases a prepared statement.</li>
        </ol>
        See <a href="https://mariadb.com/kb/en/mariadb/prepare-statement/">Server prepare documentation</a> for more information.

        PREPARE and DEALLOCATE PREPARE will be 2 additional client-server round-trip. So query execution may be faster sometime, but that's far from always the case.

        Using mariadb 10.2 server,
    </p>
<br/>
    <h3>Single SELECT / INSERT query</h3>
    <pre class="java">
    BenchmarkSelect1RowPrepareHit.mariadb               avgt  500      45.160&#177;   0.584  us/op
    BenchmarkSelect1RowPrepareMiss.mariadb              avgt  500     102.548&#177;   1.216  us/op
    BenchmarkSelect1RowPrepareText.mariadb              avgt  500      51.771&#177;   0.813  us/op

    ...
    BenchmarkOneInsertPrepareHit.mariadb                avgt  500      62.674&#177;   1.741  us/op
    BenchmarkOneInsertPrepareMiss.mariadb               avgt  500     135.067&#177;   3.274  us/op
    BenchmarkOneInsertPrepareText.mariadb               avgt  500      72.368&#177;   1.461  us/op</pre>

    <div id="box_selectOne"></div>
    <script>
        google.charts.setOnLoadCallback(function () {
            var data = defaultMariaData();
            var array = [
                ['Without PREPARE', 51.771, 0.813],
                ['With PREPARE with cache miss', 102.548,   1.216],
                ['With PREPARE with cache hit', 45.160,   0.584]
            ];
            data.addRows(getOneBoxPlotValues(array, true));

            var chart = new google.visualization.BarChart(document.getElementById('box_selectOne'));
            var select1RowsOption = defaultMariaDBOptions;
            select1RowsOption.title = "Time for a SELECT query of 1 rows";
            select1RowsOption.height = 220;
            chart.draw(data, select1RowsOption);
        });
    </script>

    <div id="box_insertOneMaria"></div>

    <script>
        google.charts.setOnLoadCallback(function () {
            var data = defaultMariaData();
            var array = [
                ['Without PREPARE', 72.368,   1.461],
                ['With PREPARE with cache miss', 135.067,   3.274],
                ['With PREPARE with cache hit', 62.674,   1.741]
            ];
            data.addRows(getOneBoxPlotValues(array, false));

            var select1RowsOption = defaultMariaDBOptions;
            select1RowsOption.title = "Execution time for one INSERT";
            select1RowsOption.height = 220;
            var chart = new google.visualization.BarChart(document.getElementById('box_insertOneMaria'));
            chart.draw(data, select1RowsOption);
        });
    </script>

    <p>When PREPARE for this exact query is already in cache (cache hit), query will be faster (13.8% for the SELECT) than without prepare.
        Due to the additional request PREPARE and DEALLOCATE exchanges, cache miss is 98.1% slower.</p>

    <p><a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html">Statement</a> will never use PREPARE.
        <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html">PreparedStatement</a> will use by default PREPARE statement.
        Enable/disable PREPARE for preparedStatement can be disable using option <a href="https://github.com/MariaDB/mariadb-connector-j/blob/master/documentation/Use-MariaDB-Connector-j-driver.md#user-content-useServerPrepStmts">useServerPrepStmts</a>.
    </p>
    <p>
        As a developer you must implement application knowing when to use Statement and when to use PreparedStatement.<br/>
        ORM will use almost exclusively PrepareStatement.<br/>
    </p>

    <p>
        Default java MariaDB cache size is 250.<br>
        You may want to increase cache. You must know that every prepare in cache take 40bytes client side.<br/>
        So configuration with 1000 prepared result in cache in a pool of 30 connection will use : 1000 * 30 * 40 = 1200kb.
        Global max prepared statement on server is variable "max_prepared_stmt_count" default to 16382 will have to be set accordingly to the total number of client.
    </p>
    <br/>

    <h3>1000 INSERT query</h3>
    <pre class="java">
BenchmarkBatch1000InsertPrepare.mariadb             avgt  500      59.020&#177;   2.375  ms/op
BenchmarkBatch1000InsertText.mariadb                avgt  500      78.093&#177;   2.745  ms/op</pre>
    <div id="box_select1000Maria"></div>

    <script>
        google.charts.setOnLoadCallback(drawSelectOnePlot);
        function drawSelectOnePlot() {
            var data = defaultMariaData();
            var array = [
                ['Without PREPARE', 78.093,   2.745],
                ['With PREPARE', 59.020,   2.375]
            ];
            data.addRows(getOneBoxPlotValues(array, true));

            var select1RowsOption = defaultMariaDBOptions;
            select1RowsOption.title = "Time for inserting 1000 rows";
            select1RowsOption.hAxis.title= 'milliseconds';
            select1RowsOption.height = 190;
            var chart = new google.visualization.BarChart(document.getElementById('box_select1000Maria'));
            chart.draw(data, select1RowsOption);
        }

    </script>
    <p>
        This is where PREPARE has the more signification.
        Using server PREPARE to insert 1000 rows take 24.4% less than without (don't forget INSERT are send into BLACKHOLE engine).
    </p>

    <br/><br/>
    <h1>Comparaison with other drivers</h1>
    <h2>SELECT query with one row result</h2>
<pre class="java">
BenchmarkSelect1RowPrepareHit.mariadb               avgt  500      45.160&#177;   0.584  us/op
BenchmarkSelect1RowPrepareHit.mysql                 avgt  500      63.283&#177;   0.934  us/op
BenchmarkSelect1RowPrepareMiss.mariadb              avgt  500     102.548&#177;   1.216  us/op
BenchmarkSelect1RowPrepareMiss.mysql                avgt  500     133.809&#177;   1.323  us/op
BenchmarkSelect1RowPrepareText.drizzle              avgt  500      71.834&#177;   0.750  us/op
BenchmarkSelect1RowPrepareText.mariadb              avgt  500      51.771&#177;   0.813  us/op
BenchmarkSelect1RowPrepareText.mysql                avgt  500      69.498&#177;   0.853  us/op
BenchmarkSelect1RowPrepareTextHA.mariadb            avgt  500      53.430&#177;   0.681  us/op
BenchmarkSelect1RowPrepareTextHA.mysql              avgt  500     122.346&#177;   1.135  us/op
</pre>
    <div id="box_select"></div>

    <script>

        google.charts.setOnLoadCallback(drawSelectPlot);
        function drawSelectPlot() {
            var data = defaultData();
            var array = [
                ['Without PREPARE', 69.498,   0.853, 51.771,   0.813, 71.834,   0.750],
                ['Without PREPARE HA', 122.346,   1.135, 53.430,   0.681, 0.0, 0.0],
                ['With PREPARE with cache miss', 133.809,   1.323, 102.548,   1.216, 0.0, 0.0],
                ['With PREPARE with cache hit', 63.283,   0.934, 45.160,   0.584, 0.0, 0.0]
            ];
            data.addRows(getBoxPlotValues(array, true));

            var select1RowsOption = defaultOptions;
            select1RowsOption.title = "Time for selecting 1 rows";
            select1RowsOption.height = 700;
            var chart = new google.visualization.BarChart(document.getElementById('box_select'));
            chart.draw(data, select1RowsOption);
        }

    </script>
<p>
    This correspond to the execution time of query <code>SELECT ?</code>.
    <br/>
    Base (100%) correspond to execution with mysql without using PREPARE.
    </p>
<p>
    HA stand for "High Availability" using Master-Slave configuration (connection string is "jdbc:mysql:<strong>replication:</strong>//localhost:3306,localhost:3306/testj").<br/><br/>

    You can notice that using HA configuration, will add a little execution time using mariadb driver : 51.771 become 53.430 microseconds.
    This difference is due to failover handling.<br/>
    HA in mysql is using a lot of mutex, slowing a lot each execution.
    (Drizzle has no PREPARE, neither HA functionality)</p>

    <h2>"Select 1000 rows"</h2>
<pre class="java">
BenchmarkSelect1000BigRows.drizzle                  avgt  500   93563.723&#177; 676.147  us/op
BenchmarkSelect1000BigRows.mariadb                  avgt  500   88298.679&#177; 656.603  us/op
BenchmarkSelect1000BigRows.mysql                    avgt  500  105989.608&#177; 816.302  us/op
BenchmarkSelect1000Rows.drizzle                     avgt  500     751.088&#177;   5.571  us/op
BenchmarkSelect1000Rows.mariadb                     avgt  500     508.405&#177;   5.239  us/op
BenchmarkSelect1000Rows.mysql                       avgt  500     558.983&#177;   5.678  us/op
</pre>

    <div id="box_select1000"></div>
    <script>

        google.charts.setOnLoadCallback(drawSelectPlot);
        function drawSelectPlot() {
            var data = defaultData();
            var array = [
                ['Select 1000 rows', 558.983,   5.678, 508.405,   5.239, 751.088,   5.571]
            ];
            data.addRows(getBoxPlotValues(array, true));

            var chart = new google.visualization.BarChart(document.getElementById('box_select1000'));
            var select1000RowsOption = defaultOptions;
            select1000RowsOption.title = "Time to select 1000 rows (return an integer from 1 to 1000)";
            select1000RowsOption.height = 230;
            chart.draw(data, select1000RowsOption);
        }

    </script>

    <div id="box_select1000Bigs"></div>
    <script>

        google.charts.setOnLoadCallback(drawSelectPlot);
        function drawSelectPlot() {
            var data = defaultData();
            var array = [
                ['Select 1000 big rows', 105989.608, 816.302, 88298.679, 656.603, 93563.723, 676.147]
            ];

            data.addRows(getBoxPlotValues(array, true));

            var chart = new google.visualization.BarChart(document.getElementById('box_select1000Bigs'));
            var select1000BigRowsOption = defaultOptions;
            select1000BigRowsOption.title = "Time to select 1000 big rows (10kb of data for each rows)";
            select1000BigRowsOption.height = 230;
            chart.draw(data, select1000BigRowsOption);
        }

    </script>
    <br/>
    <p>
        <ul>
            <li>First graphic correspond a the query <code>select * from seq_1_to_1000</code>, using the <a href="https://mariadb.com/kb/en/mariadb/sequence/">sequence storage engine</a> that will create 1000 results containing integer from 1 to 1000</li>
            <li>Second graphic correspond to the query <code>select repeat('a', 10000) from seq_1_to_1000</code>, using the <a href="https://mariadb.com/kb/en/mariadb/sequence/">sequence storage engine</a> that will create 1000 results containing 10kb 'a'.</li>
        </ul>
        This correspond to executing the result AND reading the results : <br/>
        <pre><code class="java">
            private String request = "select * from seq_1_to_1000";

            private ResultSet select1000Row(Connection connection) throws SQLException {
                try (Statement statement = connection.createStatement()) {
                    try (ResultSet rs = statement.executeQuery(request)) {
                        while (rs.next()) {
                            rs.getString(1);
                        }
                        return rs;
                    }
                }
            }
        </code></pre>
    </p>

    <p>
        The drivers have different results. <br/>
        In fact, for select, if not reading the results, if test was only executing the SELECT, execution time would be equivalent for mysql and mariadb, even 1% faster for mysql !<br/>
        But since SELECT query goal are to have results, mariadb driver is optimized to read results (avoiding the creation of one buffer comparing to mysql driver).
    </p>

    <h2>Insert queries</h2>
    <h3>"insert 1 rows"</h3>
<pre class="java">
BenchmarkOneInsertPrepareHit.mariadb                avgt  500      62.674&#177;   1.741  us/op
BenchmarkOneInsertPrepareHit.mysql                  avgt  500      66.582&#177;   1.400  us/op
BenchmarkOneInsertPrepareMiss.mariadb               avgt  500     135.067&#177;   3.274  us/op
BenchmarkOneInsertPrepareMiss.mysql                 avgt  500     165.441&#177;   3.592  us/op
BenchmarkOneInsertPrepareText.drizzle               avgt  500      90.572&#177;   1.687  us/op
BenchmarkOneInsertPrepareText.mariadb               avgt  500      72.368&#177;   1.461  us/op
BenchmarkOneInsertPrepareText.mysql                 avgt  500      93.846&#177;   1.567  us/op
BenchmarkOneInsertPrepareTextHA.mariadb             avgt  500      76.859&#177;   1.636  us/op
BenchmarkOneInsertPrepareTextHA.mysql               avgt  500     152.755&#177;   2.523  us/op
</pre>
    <p>
        time to execute a query like "INSERT INTO PerfTextQuery (charValue) values ('abcdefghij0123456')";
    </p>
    <div id="box_insertOne"></div>
    <script>

        google.charts.setOnLoadCallback(drawSelectPlot);
        function drawSelectPlot() {
            var array = [
                ['Without PREPARE', 93.846,   1.567, 72.368,   1.461, 90.572,   1.687],
                ['Without PREPARE HA', 152.755,   2.523, 76.859,   1.636, 0.0, 0.0],
                ['With PREPARE with cache miss', 165.441,   3.592, 135.067,   3.274, 0.0, 0.0],
                ['With PREPARE with cache hit', 66.582,   1.400, 62.674,   1.741, 0.0, 0.0]
            ];

            var data = defaultData();
            data.addRows(getBoxPlotValues(array, false));

            var chart = new google.visualization.BarChart(document.getElementById('box_insertOne'));
            var insertOneRowOption = defaultOptions;
            insertOneRowOption.title = "Insert one row";
            insertOneRowOption.height = 600;
            chart.draw(data, insertOneRowOption);
        }

    </script>

<pre class="java">
BenchmarkBatch1000InsertPrepare.mariadb             avgt  500      59.020&#177;   2.375  ms/op
BenchmarkBatch1000InsertPrepare.mysql               avgt  500      71.707&#177;   3.079  ms/op
BenchmarkBatch1000InsertRewrite.mariadb             avgt  500       2.263&#177;   0.063  ms/op
BenchmarkBatch1000InsertRewrite.mysql               avgt  500       1.897&#177;   0.045  ms/op
BenchmarkBatch1000InsertText.drizzle                avgt  500      94.771&#177;   3.199  ms/op
BenchmarkBatch1000InsertText.mariadb                avgt  500      78.093&#177;   2.745  ms/op
BenchmarkBatch1000InsertText.mysql                  avgt  500      85.060&#177;   2.792  ms/op
</pre>
    <div id="box_insert1000"></div>

    <script>

        google.charts.setOnLoadCallback(function () {
            var array = [
                ['Without PREPARE', 85.060,   2.792, 78.093,   2.745, 94.771,   3.199],
                ['With PREPARE', 71.707,   3.079, 59.020,   2.375, 0, 0]
            ];

            var data = defaultData();
            data.addRows(getBoxPlotValues(array, false));

            var chart = new google.visualization.BarChart(document.getElementById('box_insert1000'));
            var select1000RowsOption = defaultOptions;
            select1000RowsOption.title = "Insert 1000 rows";
            select1000RowsOption.height = 400;
            select1000RowsOption.hAxis.title= 'milliseconds';
            chart.draw(data, select1000RowsOption);
        });

    </script>

    <div id="box_insert1000Rewrite"></div>

    <script>

        google.charts.setOnLoadCallback(function () {
            var array = [
                ['With rewrite', 1.897,   0.045, 2.263,   0.063]
            ];

            var data = defaultDataWithoutDrizzle();
            data.addRows(getBoxPlotValues(array, false));

            var chart = new google.visualization.BarChart(document.getElementById('box_insert1000Rewrite'));
            var select1000RowsOption = defaultOptions;
            select1000RowsOption.title = "Insert 1000 rows using rewrite ";
            select1000RowsOption.height = 180;
            select1000RowsOption.hAxis.title= 'milliseconds';
            chart.draw(data, select1000RowsOption);
        });

    </script>

    <p>
        Ouch, this time mysql driver behave better than Mariadb driver 1.4.4.
        After analysing the time spend in driver, every write of parameters to the byte array buffer was checking that
        buffer size was big enought.
        An improvement will be released in version 1.5.0.
        Running the test for this specific test "BenchmarkBatch1000InsertRewrite" :
        nohup java -Xmx64m -Xms64m -Duser.country=US -Duser.language=en -jar benchmarks.jar ".BenchmarkBatch1000InsertRewrite"> result.txt &
        with the 1.5.0-SNAPSHOT version giver better results (<a href="./result_mariadb_server_rewrite_1.5.0-SNAPSHOT.txt">results</a>) :
    </p>
<pre class="java">
Benchmark                                Mode  Cnt  Score   Error  Units
BenchmarkBatch1000InsertRewrite.mariadb  avgt  500  1.744 ± 0.029  ms/op
BenchmarkBatch1000InsertRewrite.mysql    avgt  500  1.779 ± 0.032  ms/op
</pre>
    <div id="box_insert1000Rewrite2"></div>
    <script>

        google.charts.setOnLoadCallback(function () {
            var array = [
                ['With rewrite', 1.779, 0.032, 1.744, 0.029]
            ];

            var data = defaultDataMaria15();
            data.addRows(getBoxPlotValues(array, false));

            var chart = new google.visualization.BarChart(document.getElementById('box_insert1000Rewrite2'));
            var select1000RowsOption = defaultOptions;
            select1000RowsOption.title = "Insert 1000 rows using rewrite with mariadb 1.5.0-SNAPSHOT version";
            select1000RowsOption.height = 180;
            select1000RowsOption.series[1].color= '#109618';
            select1000RowsOption.hAxis.title= 'milliseconds';
            chart.draw(data, select1000RowsOption);
        });

    </script>



    <br/>
    <h2>Store procedures</h2>
    <h3>Function call</h3>

    <pre class="java">
BenchmarkCallableStatementFunction.mariadb          avgt  500     112.662&#177;   2.579  us/op
BenchmarkCallableStatementFunction.mysql            avgt  500    1657.960&#177;  46.456  us/op</pre>
    <div id="box_function"></div>
    <script>
        google.charts.setOnLoadCallback(function () {
            var data = defaultDataWithoutDrizzle();
            var array = [
                ['Calling function', 1657.960,  46.456, 112.662,   2.579]
            ];
            data.addRows(getBoxPlotValues(array, true));

            var chart = new google.visualization.BarChart(document.getElementById('box_function'));
            var select1RowsOption = defaultOptions;
            select1RowsOption.title = "Execution time for a function call";
            select1RowsOption.hAxis.title= 'microseconds';
            select1RowsOption.height = 220;
            select1RowsOption.series[1].color= '#4285F4';
            chart.draw(data, select1RowsOption);
        });
    </script>
    <p>There is a big difference, because the implementation completely differ.</p>
    <p>MariaDB driver makes a basic parsing to identify if query is a function or a procedure, and when format correspond to a function call <br/>
        {?= call &lt;procedure-name&gt;[(&lt;arg1&gt;,&lt;arg2&gt;, ...)]} <br/>
        will transform this to a standard query : SELECT &lt;procedure-name&gt;[(&lt;arg1&gt;,&lt;arg2&gt;, ...)]<br/>
    </p>
    <br/>
    <h3>Procedure call</h3>

    <pre class="java">
BenchmarkCallableStatementWithOutParameter.mariadb  avgt  500      71.376&#177;   1.348  us/op
BenchmarkCallableStatementWithOutParameter.mysql    avgt  500    1701.757&#177;  50.215  us/op</pre>

    <div id="box_procedure"></div>
    <script>
        google.charts.setOnLoadCallback(function () {
            var data = defaultDataWithoutDrizzle();
            var array = [
                ['Calling function', 1701.757,  50.215 , 71.376,   1.348]
            ];
            data.addRows(getBoxPlotValues(array, true));

            var chart = new google.visualization.BarChart(document.getElementById('box_procedure'));
            var select1RowsOption = defaultOptions;
            select1RowsOption.title = "Execution time for a procedure call";
            select1RowsOption.hAxis.title= 'microseconds';
            select1RowsOption.height = 220;
            chart.draw(data, select1RowsOption);
        });
    </script>
    <p>Like function, implementation completely differ.</p>
    <p>Mysql will use many hidden query to obtain output result.<br/>
    <p>MariadDB implementation is straightForward using a capability to have OUT parameter in server response without any additional queries.<br/>
        (That's the main reason why MariaDB 1.4 driver now require MariaDB/MySQL version 5.5.3 minimum).<br/>
    </p>
    <br/>
    <script>
        hljs.initHighlightingOnLoad();
    </script>
</div>
</body>
</html>
